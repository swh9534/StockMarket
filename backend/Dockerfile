# ğŸ”¹ ë¹Œë“œ ìŠ¤í…Œì´ì§€
FROM eclipse-temurin:17-alpine AS build
RUN apk add --no-cache bash curl

WORKDIR /app

# Maven Wrapper ë° ì˜ì¡´ì„± ë‹¤ìš´ë¡œë“œ
COPY mvnw .
COPY .mvn .mvn
COPY pom.xml .

RUN chmod +x ./mvnw && ./mvnw dependency:go-offline -B

# í”„ë¡œì íŠ¸ ì½”ë“œ ë³µì‚¬ í›„ ë¹Œë“œ
COPY . .

RUN ./mvnw package -DskipTests

# ğŸ”¹ ëŸ°íƒ€ì„ ìŠ¤í…Œì´ì§€
FROM eclipse-temurin:17-jre-alpine as runtime

WORKDIR /app

# ì‹œìŠ¤í…œ ì‚¬ìš©ì ì¶”ê°€
RUN addgroup -g 1000 worker && \
    adduser -u 1000 -G worker -s /bin/sh -D worker

COPY --from=build /app/target/*.jar ./main.jar

RUN chown worker:worker ./main.jar

USER worker:worker

# ê¸°ë³¸ í”„ë¡œíŒŒì¼ ì§€ì • (ì—†ì„ ê²½ìš° 'dev'ë¡œ ì‹¤í–‰)
ENV PROFILE=${PROFILE:-dev}

EXPOSE 8080

ENTRYPOINT ["java", "-Dspring.profiles.active=${PROFILE}", "-jar", "main.jar"]